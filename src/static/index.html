<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BaiTTS WebUI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root { --card-border-radius: 12px; }
        body { background-color: #f4f6f9; padding-bottom: 40px; }
        [data-bs-theme="dark"] body { background-color: #121212; }
        .card { border: none; border-radius: var(--card-border-radius); box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 20px; transition: transform 0.2s; }
        .card-header { background-color: transparent; border-bottom: 1px solid rgba(0,0,0,0.05); font-weight: 600; padding: 1rem 1.25rem; }
        [data-bs-theme="dark"] .card-header { border-bottom-color: rgba(255,255,255,0.05); }
        .param-label { font-weight: 500; font-size: 0.9rem; color: #6c757d; }
        [data-bs-theme="dark"] .param-label { color: #adb5bd; }
        #logs { height: 300px; overflow-y: auto; background: #1e1e1e; color: #00ff9d; padding: 15px; font-family: 'Consolas', monospace; border-radius: 8px; font-size: 0.85rem; }
        .nav-tabs .nav-link { border-radius: 8px 8px 0 0; color: var(--bs-body-color); }
        .nav-tabs .nav-link.active { font-weight: bold; }
        .form-range::-webkit-slider-thumb { background: var(--bs-primary); }
        .badge { font-weight: 500; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4 sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="#"><i class="bi bi-soundwave"></i> BaiTTS <small class="text-muted fw-normal fs-6">æœ‰å£°ä¹¦åˆæˆå·¥å…·</small></a>
            <div class="d-flex align-items-center gap-3">
                 <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#settingsModal">
                    <i class="bi bi-gear"></i> è®¾ç½®
                 </button>
                 <div class="form-check form-switch mb-0" title="æ·±è‰²æ¨¡å¼">
                    <input class="form-check-input" type="checkbox" id="darkModeSwitch">
                    <label class="form-check-label" for="darkModeSwitch"><i class="bi bi-moon-stars"></i></label>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- è¾“å…¥å†…å®¹ -->
        <div class="card">
            <div class="card-header bg-warning text-dark">è¾“å…¥å†…å®¹</div>
            <div class="card-body">
                <ul class="nav nav-tabs mb-3" id="inputTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="text-tab" data-bs-toggle="tab" data-bs-target="#text-pane" type="button">ç›´æ¥æ–‡æœ¬</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="file-tab" data-bs-toggle="tab" data-bs-target="#file-pane" type="button">æœ¬åœ°æ–‡ä»¶è·¯å¾„</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-pane" type="button">ä¸Šä¼ æ–‡ä»¶</button>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="text-pane">
                        <textarea id="textContent" class="form-control" rows="5" placeholder="åœ¨æ­¤è¾“å…¥è¦æœ—è¯»çš„æ–‡æœ¬..."></textarea>
                        <div class="mt-2 d-flex gap-2 align-items-center">
                            <div class="flex-grow-1">
                                <label class="form-label visually-hidden">ä¿å­˜æ–‡ä»¶å</label>
                                <input type="text" id="outputName" class="form-control" placeholder="ä¿å­˜æ–‡ä»¶å (å¯é€‰ï¼Œé»˜è®¤ä¸º web_task)">
                            </div>
                            <button class="btn btn-secondary" id="btnPreview">ğŸ§ è¯•å¬</button>
                            <button class="btn btn-outline-primary" id="btnDownloadPreview" style="display:none;">â¬‡ï¸ ä¸‹è½½</button>
                        </div>
                        <audio id="audioPreview" controls style="display:none; width: 100%; margin-top: 10px;"></audio>
                    </div>
                    <div class="tab-pane fade" id="file-pane">
                        <div class="alert alert-info">è¯·è¾“å…¥æœåŠ¡å™¨(æœ¬æœº)ä¸Šçš„ç»å¯¹è·¯å¾„ã€‚æ”¯æŒ .txt, .epub</div>
                        <input type="text" id="filePath" class="form-control" placeholder="D:\books\story.epub">
                    </div>
                    <div class="tab-pane fade" id="upload-pane">
                        <div class="alert alert-info">ç›´æ¥ä»æ‚¨çš„ç”µè„‘ä¸Šä¼ æ–‡ä»¶è¿›è¡Œå¤„ç†ã€‚æ”¯æŒ .txt, .epub</div>
                        <input type="file" id="uploadFile" class="form-control">
                    </div>
                </div>
            </div>
        </div>

        <!-- æ–‡ä»¶ç®¡ç† -->
        <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <span>ğŸ“‚ æ–‡ä»¶ç®¡ç†</span>
                <div class="btn-group btn-group-sm">
                    <input type="radio" class="btn-check" name="fmRoot" id="fmRootBook" value="book" checked>
                    <label class="btn btn-outline-light" for="fmRootBook">ä¹¦ç±ç›®å½• (/book)</label>
                    <input type="radio" class="btn-check" name="fmRoot" id="fmRootOutput" value="output">
                    <label class="btn btn-outline-light" for="fmRootOutput">è¾“å‡ºç›®å½• (/output)</label>
                </div>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0" id="fmBreadcrumb">
                            <li class="breadcrumb-item active">/</li>
                        </ol>
                    </nav>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-secondary" id="btnFmRefresh"><i class="bi bi-arrow-clockwise"></i> åˆ·æ–°</button>
                        <button class="btn btn-sm btn-success" id="btnFmUpload" data-bs-toggle="modal" data-bs-target="#uploadModal"><i class="bi bi-upload"></i> ä¸Šä¼ æ–‡ä»¶</button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover table-sm align-middle">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 50%">åç§°</th>
                                <th style="width: 15%">å¤§å°</th>
                                <th style="width: 20%">ä¿®æ”¹æ—¶é—´</th>
                                <th style="width: 15%" class="text-end">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="fmFileList">
                            <tr><td colspan="4" class="text-center text-muted">åŠ è½½ä¸­...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- æ‰¹é‡è½¬æ¢ -->
        <div class="card">
            <div class="card-header bg-info text-white">æ‰¹é‡è½¬æ¢</div>
            <div class="card-body">
                <div class="alert alert-info">
                    æ­¤åŠŸèƒ½ä¼šå¤„ç† Docker å· <code>/book</code> å†…æ‰€æœ‰ <code>.txt</code> å’Œ <code>.epub</code> æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ä¸Šæ–¹é€‰æ‹©çš„å£°éŸ³è¿›è¡Œè½¬æ¢ã€‚éŸ³é¢‘æ–‡ä»¶å°†ä¿å­˜åˆ° <code>/out</code> å·ã€‚
                    <br>è¯·ç¡®ä¿å·²é€šè¿‡ <code>-v /your/books:/book</code> å’Œ <code>-v /your/output:/out</code> æ­£ç¡®æŒ‚è½½ç›®å½•ã€‚
                </div>
                <div class="d-grid gap-2">
                    <button class="btn btn-warning btn-lg" id="btnBatchConvert">å¼€å§‹æ‰¹é‡è½¬æ¢</button>
                    <button class="btn btn-outline-success" id="btnAutoRun">ğŸ¤– å¼€å¯è‡ªåŠ¨æ£€æµ‹</button>
                </div>
            </div>
        </div>

        <!-- ä»»åŠ¡è¿›åº¦ -->
        <div class="card" id="tasksCard" style="display: none;">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <span>ä»»åŠ¡è¿›åº¦</span>
                <div>
                    <button class="btn btn-sm btn-outline-warning me-2" onclick="retryAllFailed()">å…¨éƒ¨é‡è¯•</button>
                    <button class="btn btn-sm btn-outline-danger me-2" onclick="clearAllTasks()">æ¸…ç©ºæ‰€æœ‰</button>
                    <button class="btn btn-sm btn-outline-light me-2" onclick="clearCompletedTasks()">æ¸…é™¤å·²å®Œæˆ</button>
                    <button class="btn btn-sm btn-danger" onclick="resetHistory()" title="å½»åº•æ¸…é™¤æ‰€æœ‰è®°å½•ï¼ˆåŒ…æ‹¬å·²å®Œæˆçš„ï¼‰ï¼Œå…è®¸é‡æ–°æ‰«æ">å½»åº•é‡ç½®</button>
                    <span class="badge bg-light text-dark" id="taskCountBadge">0/0</span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="p-2 border-bottom d-flex gap-2 align-items-center">
                    <div class="form-check mb-0">
                        <input class="form-check-input" type="checkbox" id="selectAllTasks">
                        <label class="form-check-label" for="selectAllTasks" style="white-space: nowrap;">å…¨é€‰</label>
                    </div>
                    <select class="form-select form-select-sm" id="taskStatusFilter" style="max-width: 120px;">
                        <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="pending">ç­‰å¾…ä¸­</option>
                        <option value="processing">è¿›è¡Œä¸­</option>
                        <option value="completed">å·²å®Œæˆ</option>
                        <option value="error">å¤±è´¥</option>
                        <option value="cancelled">å·²å–æ¶ˆ</option>
                    </select>
                    <input type="text" class="form-control form-control-sm" id="taskSearchInput" placeholder="ğŸ” æœç´¢æ–‡ä»¶å...">
                    <div class="btn-group btn-group-sm" id="batchActions" style="display:none;">
                        <button class="btn btn-outline-danger" onclick="batchCancel()">æ‰¹é‡å–æ¶ˆ</button>
                        <button class="btn btn-outline-warning" onclick="batchRetry()">æ‰¹é‡é‡è¯•</button>
                    </div>
                </div>
                <div class="list-group list-group-flush" id="taskList" style="max-height: 300px; overflow-y: auto;">
                    <!-- ä»»åŠ¡åˆ—è¡¨é¡¹æ¨¡æ¿ -->
                    <!--
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">Book Name.epub</h6>
                            <small>Processing</small>
                        </div>
                        <div class="progress" style="height: 5px;"><div class="progress-bar" style="width: 50%"></div></div>
                    </div>
                    -->
                </div>
            </div>
            <div class="card-footer p-1">
                <nav>
                    <ul class="pagination pagination-sm justify-content-center mb-0" id="taskPagination"></ul>
                </nav>
            </div>
        </div>

        <!-- æ§åˆ¶ -->
        <div class="d-grid gap-2 mb-4 d-md-flex">
            <button class="btn btn-primary btn-lg flex-grow-1" id="btnStart">å¼€å§‹åˆæˆ</button>
            <button class="btn btn-danger btn-lg flex-grow-1" id="btnStop" disabled>åœæ­¢åˆæˆ</button>
        </div>

        <!-- æ—¥å¿— -->
        <div class="card">
            <div class="card-header bg-dark text-white">è¿è¡Œæ—¥å¿—</div>
            <div class="card-body p-0">
                <div id="logs">
                    <div>ç­‰å¾…æ“ä½œ...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel">è®¾ç½®</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- API è®¾ç½® -->
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">API è®¾ç½®</div>
                        <div class="card-body">
                            <div class="input-group">
                                <span class="input-group-text">MultiTTS API åœ°å€</span>
                                <input type="text" id="apiUrl" class="form-control" value="http://127.0.0.1:8774" placeholder="ä¾‹å¦‚ http://192.168.1.5:8774">
                                <button class="btn btn-success" type="button" id="btnRefreshVoices">è·å–å£°éŸ³åˆ—è¡¨</button>
                            </div>
                        </div>
                    </div>

                    <!-- å‚æ•°è®¾ç½® -->
                    <div class="card">
                        <div class="card-header bg-success text-white">å£°éŸ³å‚æ•°</div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label param-label">é€‰æ‹©å£°éŸ³</label>
                                <select id="voiceSelect" class="form-select">
                                    <option value="" disabled selected>è¯·å…ˆè·å–å£°éŸ³åˆ—è¡¨...</option>
                                </select>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label param-label">è¯­é€Ÿ (Speed): <span id="speedVal">50</span></label>
                                    <input type="range" class="form-range" id="speed" min="0" max="100" value="50">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label param-label">éŸ³é‡ (Volume): <span id="volumeVal">100</span></label>
                                    <input type="range" class="form-range" id="volume" min="0" max="100" value="100">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label param-label">éŸ³è°ƒ (Pitch): <span id="pitchVal">50</span></label>
                                    <input type="range" class="form-range" id="pitch" min="0" max="100" value="50">
                                </div>
                            </div>

                            <div class="row mt-3">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label param-label">å¹¶å‘æ•° (Concurrency): <span id="concurrencyVal">4</span></label>
                                    <input type="range" class="form-range" id="concurrency" min="1" max="32" value="4">
                                    <div class="form-text">åŒæ—¶å¤„ç†çš„ç« èŠ‚æ•°é‡ã€‚è®¾ç½®è¿‡é«˜å¯èƒ½å¯¼è‡´ API è¶…æ—¶æˆ–æŠ¥é”™ã€‚</div>
                                </div>
                                <div class="col-md-6 d-flex align-items-center">
                                    <div class="form-check form-switch mt-2">
                                        <input class="form-check-input" type="checkbox" id="preserveStructure">
                                        <label class="form-check-label" for="preserveStructure">ä¿æŒç›®å½•ç»“æ„ (Preserve Structure)</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- å¯¹è¯éƒ¨åˆ†ç‹¬ç«‹è®¾ç½® -->
                            <fieldset class="mt-3 border p-3 rounded">
                                <legend class="w-auto px-2 fs-6 fw-bold">ğŸ—£ï¸ å¯¹è¯éƒ¨åˆ†ç‹¬ç«‹è®¾ç½® (å¯é€‰)</legend>
                                
                                <div class="mb-3">
                                    <label class="form-label param-label">å¯¹è¯å‘éŸ³äºº</label>
                                    <select id="voice_dialogue_id" class="form-select">
                                        <option value="">-- è·Ÿéšä¸»å‘éŸ³äºº --</option>
                                    </select>
                                    <div class="form-text">è‹¥ä¸é€‰æ‹©ï¼Œåˆ™å¯¹è¯éƒ¨åˆ†ä½¿ç”¨ä¸»å‘éŸ³äººã€‚</div>
                                </div>

                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label param-label">å¯¹è¯è¯­é€Ÿ: <span id="val_speed_dialogue">50</span></label>
                                        <input type="range" class="form-range" id="speed_dialogue" min="0" max="100" value="50">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label param-label">å¯¹è¯éŸ³é‡: <span id="val_volume_dialogue">50</span></label>
                                        <input type="range" class="form-range" id="volume_dialogue" min="0" max="100" value="50">
                                    </div>
                                    <div class="col-md-4">
                                        <label class="form-label param-label">å¯¹è¯éŸ³è°ƒ: <span id="val_pitch_dialogue">50</span></label>
                                        <input type="range" class="form-range" id="pitch_dialogue" min="0" max="100" value="50">
                                    </div>
                                </div>
                            </fieldset>

                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enableLrc">
                                        <label class="form-check-label" for="enableLrc">ç”Ÿæˆ LRC æ­Œè¯æ–‡ä»¶</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row mt-2" id="lrcConfig" style="display: none;">
                                <div class="col-md-6">
                                    <label class="form-label">æ¯è¡Œæœ€å¤§å­—ç¬¦æ•°</label>
                                    <input type="number" class="form-control" id="lrcChars" value="15" min="10" max="100">
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <label class="form-label param-label">å¿½ç•¥å†…å®¹æ­£åˆ™ (Ignore Regex)</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="ignoreRegex" value="\*{3,}|#{2,}" placeholder="æ­£åˆ™è¡¨è¾¾å¼">
                                        <button class="btn btn-outline-secondary" type="button" id="btnTestRegex">æµ‹è¯•æ­£åˆ™</button>
                                    </div>
                                    <div class="form-text">åŒ¹é…åˆ°çš„å†…å®¹å°†è¢«åˆ é™¤ï¼Œä¸è¿›è¡Œåˆæˆã€‚</div>
                                </div>
                            </div>
                            <div class="mt-3 text-end">
                                <button class="btn btn-outline-secondary btn-sm" id="btnResetDefaults">â†º æ¢å¤é»˜è®¤è®¾ç½®</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä»»åŠ¡è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div class="modal fade" id="taskDetailsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ä»»åŠ¡è¯¦æƒ…</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="taskDetailsBody"></div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="btnCopyConfig">å¤åˆ¶é…ç½®</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ­£åˆ™æµ‹è¯•æ¨¡æ€æ¡† -->
    <div class="modal fade" id="regexTestModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ­£åˆ™è¡¨è¾¾å¼æµ‹è¯•</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">æ­£åˆ™è¡¨è¾¾å¼</label>
                        <input type="text" class="form-control" id="testRegexInput">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">æµ‹è¯•æ–‡æœ¬</label>
                        <textarea class="form-control" id="testRegexText" rows="3">è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ–‡æœ¬***éœ€è¦å¿½ç•¥çš„éƒ¨åˆ†##ä¿ç•™çš„éƒ¨åˆ†</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">å¤„ç†ç»“æœ</label>
                        <textarea class="form-control" id="testRegexResult" rows="3" readonly></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="btnRunRegexTest">æ‰§è¡Œæµ‹è¯•</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸Šä¼ æ–‡ä»¶æ¨¡æ€æ¡† -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ä¸Šä¼ æ–‡ä»¶</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>ä¸Šä¼ æ–‡ä»¶åˆ°å½“å‰ç›®å½•: <code id="uploadTargetDir">/</code></p>
                    <input type="file" class="form-control" id="fmUploadInput" multiple>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" id="btnConfirmUpload">å¼€å§‹ä¸Šä¼ </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTasksMap = {};
        let sysDefaults = { volume: 50, speed: 50, pitch: 50 };
        
        let selectedTaskIds = new Set();
        let currentFilteredTasks = [];
        let currentPage = 1;
        const itemsPerPage = 10;
        let currentSearchQuery = "";
        let currentStatusFilter = "all";

        document.addEventListener('DOMContentLoaded', async () => {
            initTheme();
            await loadInitialData();
            loadLocalStorageSettings();
            checkAutoRunStatus();
            fmLoadFiles(); // åŠ è½½æ–‡ä»¶åˆ—è¡¨
            updateTasks();
            setInterval(updateTasks, 2000);
        });

        function initTheme() {
            const themeSwitch = document.getElementById('darkModeSwitch');
            const html = document.documentElement;
            
            // è¯»å–ä¿å­˜çš„ä¸»é¢˜æˆ–é»˜è®¤ä¸º light
            const savedTheme = localStorage.getItem('theme') || 'light';
            html.setAttribute('data-bs-theme', savedTheme);
            themeSwitch.checked = savedTheme === 'dark';

            themeSwitch.addEventListener('change', () => {
                const theme = themeSwitch.checked ? 'dark' : 'light';
                html.setAttribute('data-bs-theme', theme);
                localStorage.setItem('theme', theme);
            });
        }

        function loadLocalStorageSettings() {
            ['speed_dialogue', 'volume_dialogue', 'pitch_dialogue'].forEach(id => {
                const val = localStorage.getItem(id);
                if (val) {
                    document.getElementById(id).value = val;
                    document.getElementById('val_' + id).innerText = val;
                }
                document.getElementById(id).addEventListener('input', (e) => {
                    document.getElementById('val_' + id).innerText = e.target.value;
                    localStorage.setItem(id, e.target.value);
                });
            });

            // Main settings
            ['speed', 'volume', 'pitch', 'concurrency'].forEach(id => {
                const val = localStorage.getItem(id);
                if (val) {
                    document.getElementById(id).value = val;
                    document.getElementById(id + 'Val').innerText = val;
                }
                document.getElementById(id).addEventListener('input', (e) => {
                    localStorage.setItem(id, e.target.value);
                });
            });
            
            const dialogVoice = document.getElementById('voice_dialogue_id');
            dialogVoice.addEventListener('change', (e) => {
                localStorage.setItem('voice_dialogue_id', e.target.value);
            });
            
            const mainVoice = document.getElementById('voiceSelect');
            mainVoice.addEventListener('change', (e) => {
                localStorage.setItem('voiceSelect', e.target.value);
            });

            const preserveStructure = document.getElementById('preserveStructure');
            const savedPreserve = localStorage.getItem('preserveStructure');
            if (savedPreserve !== null) {
                preserveStructure.checked = savedPreserve === 'true';
            }
            preserveStructure.addEventListener('change', (e) => {
                localStorage.setItem('preserveStructure', e.target.checked);
            });
        }

        // å‚æ•°æ˜¾ç¤ºåŒæ­¥
        ['speed', 'volume', 'pitch', 'concurrency'].forEach(id => {
            document.getElementById(id).addEventListener('input', (e) => {
                document.getElementById(id + 'Val').innerText = e.target.value;
            });
        });

        // LRC é…ç½®æ˜¾éš
        document.getElementById('enableLrc').addEventListener('change', (e) => {
            document.getElementById('lrcConfig').style.display = e.target.checked ? 'flex' : 'none';
        });

        // æ­£åˆ™æµ‹è¯•
        document.getElementById('btnTestRegex').addEventListener('click', () => {
            const currentRegex = document.getElementById('ignoreRegex').value;
            document.getElementById('testRegexInput').value = currentRegex;
            document.getElementById('testRegexResult').value = '';
            new bootstrap.Modal(document.getElementById('regexTestModal')).show();
        });

        document.getElementById('btnRunRegexTest').addEventListener('click', async () => {
            const regex = document.getElementById('testRegexInput').value;
            const text = document.getElementById('testRegexText').value;
            
            try {
                const res = await fetch('/api/test_regex', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ regex, text })
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('testRegexResult').value = data.result;
                } else {
                    document.getElementById('testRegexResult').value = "é”™è¯¯: " + data.error;
                }
            } catch (e) {
                document.getElementById('testRegexResult').value = "ç½‘ç»œé”™è¯¯: " + e;
            }
        });

        const log = (msg) => {
            const logs = document.getElementById('logs');
            const time = new Date().toLocaleTimeString();
            logs.innerHTML += `<div>[${time}] ${msg}</div>`;
            logs.scrollTop = logs.scrollHeight;
        };
        
        function populateVoices(voices, selectElement) {
            selectElement.innerHTML = ''; // Clear existing options
            if (!voices || voices.length === 0) {
                const opt = document.createElement('option');
                opt.value = "";
                opt.text = "æ— å¯ç”¨å£°éŸ³æˆ–è·å–å¤±è´¥";
                opt.disabled = true;
                selectElement.appendChild(opt);
                selectElement.value = "";
                return;
            }
            
            voices.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.id;
                opt.text = `${v.name} (${v.id})`;
                selectElement.appendChild(opt);
            });
            
            if (selectElement.id === 'voiceSelect') {
                const savedVoice = localStorage.getItem('voiceSelect');
                if (savedVoice) selectElement.value = savedVoice;
            }
            
            log(`âœ… æˆåŠŸåŠ è½½ ${voices.length} ä¸ªå£°éŸ³ã€‚`);
            
            // å¡«å……å¯¹è¯å‘éŸ³äººå¹¶æ¢å¤é€‰æ‹©
            const dialogSelect = document.getElementById('voice_dialogue_id');
            dialogSelect.innerHTML = '<option value="">-- è·Ÿéšä¸»å‘éŸ³äºº --</option>';
            voices.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v.id;
                opt.text = `${v.name} (${v.id})`;
                dialogSelect.appendChild(opt);
            });
            const savedDialogVoice = localStorage.getItem('voice_dialogue_id');
            if (savedDialogVoice) dialogSelect.value = savedDialogVoice;
        }

        async function loadInitialData() {
            log('æ­£åœ¨åŠ è½½åˆå§‹é…ç½®...');
            try {
                const res = await fetch('/api/initial_data');
                const data = await res.json();

                if (data.api_url) {
                    document.getElementById('apiUrl').value = data.api_url;
                    log('â–¶ï¸ å·²ä»ç¯å¢ƒåŠ è½½ API åœ°å€ã€‚');
                }

                if (data.default_volume !== undefined) {
                    sysDefaults.volume = data.default_volume;
                    document.getElementById('volume').value = data.default_volume;
                    document.getElementById('volumeVal').innerText = data.default_volume;
                }
                if (data.default_speed !== undefined) {
                    sysDefaults.speed = data.default_speed;
                    document.getElementById('speed').value = data.default_speed;
                    document.getElementById('speedVal').innerText = data.default_speed;
                }
                if (data.default_pitch !== undefined) {
                    sysDefaults.pitch = data.default_pitch;
                    document.getElementById('pitch').value = data.default_pitch;
                    document.getElementById('pitchVal').innerText = data.default_pitch;
                }

                if (data.voices && data.voices.length > 0) {
                    const voiceSelect = document.getElementById('voiceSelect');
                    populateVoices(data.voices, voiceSelect);
                } else if (data.api_url) {
                    log('â³ API åœ°å€å·²åŠ è½½ï¼Œæ­£åœ¨å°è¯•è·å–å£°éŸ³åˆ—è¡¨...');
                    document.getElementById('btnRefreshVoices').click();
                } else {
                    log('ğŸ’¡ æœªä»ç¯å¢ƒåŠ è½½é…ç½®ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥ API åœ°å€ã€‚')
                }

            } catch (e) {
                log('âŒ åŠ è½½åˆå§‹é…ç½®å¤±è´¥: ' + e);
            }
        }

        // ä»»åŠ¡è½®è¯¢
        async function updateTasks() {
            try {
                const res = await fetch('/api/tasks');
                const tasks = await res.json();
                const list = document.getElementById('taskList');
                const card = document.getElementById('tasksCard');
                
                currentTasksMap = {}; // é‡ç½®æ˜ å°„
                
                card.style.display = 'block';
                list.innerHTML = '';

                if (tasks.length === 0) {
                    list.innerHTML = '<div class="list-group-item text-center text-muted p-3">æš‚æ— ä»»åŠ¡è®°å½•</div>';
                    document.getElementById('taskCountBadge').innerText = '0/0';
                } else {
                    let completed = 0;
                    
                    // è¿‡æ»¤
                    const filteredTasks = tasks.filter(t => {
                        const matchesSearch = t.file_name.toLowerCase().includes(currentSearchQuery.toLowerCase());
                        const matchesStatus = currentStatusFilter === 'all' || t.status === currentStatusFilter;
                        return matchesSearch && matchesStatus;
                    });
                    currentFilteredTasks = filteredTasks;
                    
                    // åˆ†é¡µ
                    const totalPages = Math.ceil(filteredTasks.length / itemsPerPage) || 1;
                    if (currentPage > totalPages) currentPage = totalPages;
                    if (currentPage < 1) currentPage = 1;
                    
                    const start = (currentPage - 1) * itemsPerPage;
                    const end = start + itemsPerPage;
                    const pageTasks = filteredTasks.slice(start, end);

                    // ç»Ÿè®¡æ€»å®Œæˆæ•° (åŸºäºæ‰€æœ‰ä»»åŠ¡)
                    tasks.forEach(t => { if(t.status === 'completed') completed++; });
                    
                    pageTasks.forEach(t => {
                        currentTasksMap[t.id] = t; // å­˜å‚¨ä»¥ä¾¿è¯¦æƒ…ä½¿ç”¨
                        
                        let badgeClass = 'bg-secondary';
                        if(t.status === 'processing') badgeClass = 'bg-primary';
                        if(t.status === 'completed') badgeClass = 'bg-success';
                        if(t.status === 'error') badgeClass = 'bg-danger';
                        
                        let actionBtn = '';
                        if(t.status === 'pending' || t.status === 'processing') {
                            actionBtn = `<button class="btn btn-sm btn-outline-danger ms-2" onclick="cancelTask('${t.id}')">å–æ¶ˆ</button>`;
                        } else if (t.status === 'error' || t.status === 'cancelled') {
                            actionBtn = `<button class="btn btn-sm btn-outline-warning ms-2" onclick="retryTask('${t.id}')">é‡è¯•</button>`;
                        }
                        
                        let etaText = '';
                        if (t.status === 'processing' && t.eta !== null && t.eta !== undefined) {
                            const min = Math.floor(t.eta / 60);
                            const sec = t.eta % 60;
                            etaText = ` | é¢„è®¡å‰©ä½™: ${min}åˆ†${sec}ç§’`;
                        }

                        const formatSize = (bytes) => {
                            if (bytes === 0 || !bytes) return '';
                            const k = 1024;
                            const sizes = ['B', 'KB', 'MB', 'GB'];
                            const i = Math.floor(Math.log(bytes) / Math.log(k));
                            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                        };

                        const formatTime = (ts) => ts ? new Date(ts * 1000).toLocaleTimeString() : '';
                        let timeInfo = '';
                        if (t.start_time) timeInfo += `<span class="me-2" title="å¼€å§‹æ—¶é—´">â–¶ ${formatTime(t.start_time)}</span>`;
                        if (t.end_time) timeInfo += `<span title="ç»“æŸæ—¶é—´">â¹ ${formatTime(t.end_time)}</span>`;

                        const isChecked = selectedTaskIds.has(t.id) ? 'checked' : '';
                        const percent = t.total > 0 ? Math.round((t.current / t.total) * 100) : 0;
                        
                        const item = document.createElement('div');
                        item.className = 'list-group-item';
                        item.innerHTML = `
                            <div class="d-flex w-100 justify-content-between align-items-center mb-1">
                                <div class="d-flex align-items-center text-truncate" style="max-width: 60%;">
                                    <input type="checkbox" class="form-check-input me-2 task-checkbox" value="${t.id}" ${isChecked} onchange="toggleTaskSelection('${t.id}')" onclick="event.stopPropagation()">
                                    <span style="cursor: pointer; text-decoration: underline; color: var(--bs-link-color);" 
                                         title="ç‚¹å‡»æŸ¥çœ‹é…ç½®è¯¦æƒ…" onclick="showTaskDetails('${t.id}')">
                                        ${t.file_name}
                                    </span>
                                </div>
                                <div>
                                    <span class="badge ${badgeClass}">${t.status}</span>
                                    ${actionBtn}
                                </div>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar ${badgeClass}" role="progressbar" style="width: ${percent}%"></div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center" style="font-size: 0.75rem; color: #666;">
                                <span>${t.current} / ${t.total} ç« èŠ‚${etaText}</span>
                                <span class="text-muted" style="font-size: 0.7rem;">${timeInfo}</span>
                                <span class="badge bg-info text-dark" style="font-weight: normal; display: ${t.size ? 'inline-block' : 'none'}">${formatSize(t.size)}</span>
                                <span>${percent}%</span>
                            </div>
                        `;
                        list.appendChild(item);
                    });
                    document.getElementById('taskCountBadge').innerText = `${completed}/${tasks.length}`;
                    
                    // æ¸²æŸ“åˆ†é¡µæ§ä»¶
                    renderPagination(totalPages);
                    updateBatchUI();
                }
            } catch(e) {
                console.error("Fetch tasks error", e);
            }
        }

        function toggleTaskSelection(id) {
            if (selectedTaskIds.has(id)) {
                selectedTaskIds.delete(id);
            } else {
                selectedTaskIds.add(id);
            }
            updateBatchUI();
        }

        function updateBatchUI() {
            const batchDiv = document.getElementById('batchActions');
            batchDiv.style.display = selectedTaskIds.size > 0 ? 'inline-flex' : 'none';

            const selectAllCb = document.getElementById('selectAllTasks');
            if (currentFilteredTasks.length > 0 && currentFilteredTasks.every(t => selectedTaskIds.has(t.id))) {
                selectAllCb.checked = true;
                selectAllCb.indeterminate = false;
            } else if (currentFilteredTasks.some(t => selectedTaskIds.has(t.id))) {
                selectAllCb.checked = false;
                selectAllCb.indeterminate = true;
            } else {
                selectAllCb.checked = false;
                selectAllCb.indeterminate = false;
            }
        }

        function renderPagination(totalPages) {
            const pagination = document.getElementById('taskPagination');
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;

            const createPageItem = (text, page, isActive = false, isDisabled = false) => {
                const li = document.createElement('li');
                li.className = `page-item ${isActive ? 'active' : ''} ${isDisabled ? 'disabled' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="event.preventDefault(); changePage(${page})">${text}</a>`;
                return li;
            };

            pagination.appendChild(createPageItem('Â«', currentPage - 1, false, currentPage === 1));
            
            // ç®€å•åˆ†é¡µï¼šæ˜¾ç¤ºå½“å‰é¡µå’Œæ€»é¡µæ•°
            const infoLi = document.createElement('li');
            infoLi.className = 'page-item disabled';
            infoLi.innerHTML = `<span class="page-link text-muted">${currentPage} / ${totalPages}</span>`;
            pagination.appendChild(infoLi);

            pagination.appendChild(createPageItem('Â»', currentPage + 1, false, currentPage === totalPages));
        }

        function changePage(page) {
            currentPage = page;
            updateTasks();
        }

        // æœç´¢æ¡†äº‹ä»¶
        document.getElementById('taskSearchInput').addEventListener('input', (e) => {
            currentSearchQuery = e.target.value.trim();
            currentPage = 1;
            updateTasks();
        });

        // çŠ¶æ€ç­›é€‰äº‹ä»¶
        document.getElementById('taskStatusFilter').addEventListener('change', (e) => {
            currentStatusFilter = e.target.value;
            currentPage = 1;
            updateTasks();
        });

        // å…¨é€‰æ¡†äº‹ä»¶
        document.getElementById('selectAllTasks').addEventListener('change', (e) => {
            const checked = e.target.checked;
            currentFilteredTasks.forEach(t => {
                if (checked) selectedTaskIds.add(t.id);
                else selectedTaskIds.delete(t.id);
            });
            updateTasks();
        });

        function showTaskDetails(id) {
            const task = currentTasksMap[id];
            if(!task || !task.cli_config) return;
            
            const c = task.cli_config;
            const body = document.getElementById('taskDetailsBody');
            
            body.innerHTML = `
                <table class="table table-sm table-bordered mb-0">
                    <tbody>
                        <tr><th style="width: 30%">æ–‡ä»¶å</th><td class="text-break">${task.file_name}</td></tr>
                        <tr><th>çŠ¶æ€</th><td>${task.status}</td></tr>
                        <tr><th>API URL</th><td class="text-break">${c.api || '-'}</td></tr>
                        <tr><th>ä¸»å‘éŸ³äºº</th><td>${c.voice || '-'}</td></tr>
                        <tr><th>ä¸»å‚æ•°</th><td>Vol: ${c.volume}, Spd: ${c.speed}, Pit: ${c.pitch}</td></tr>
                        <tr><th>å¯¹è¯å‘éŸ³äºº</th><td>${c.voice_dialogue || '-'}</td></tr>
                        <tr><th>å¯¹è¯å‚æ•°</th><td>Vol: ${c.volume_dialogue||'-'}, Spd: ${c.speed_dialogue||'-'}, Pit: ${c.pitch_dialogue||'-'}</td></tr>
                        <tr><th>LRCè®¾ç½®</th><td>${c.sub > 0 ? `å¯ç”¨ (æ¯è¡Œ${c.sub}å­—)` : 'ç¦ç”¨'}</td></tr>
                        <tr><th>å®Œæ•´è·¯å¾„</th><td class="text-break">${task.full_path || '-'}</td></tr>
                        <tr><th>å¼€å§‹æ—¶é—´</th><td>${task.start_time ? new Date(task.start_time * 1000).toLocaleString() : '-'}</td></tr>
                        <tr><th>ç»“æŸæ—¶é—´</th><td>${task.end_time ? new Date(task.end_time * 1000).toLocaleString() : '-'}</td></tr>
                        <tr><th>è¾“å‡ºå¤§å°</th><td>${task.size ? formatSize(task.size) : '-'}</td></tr>
                        ${task.error_msg ? `<tr><th class="text-danger">é”™è¯¯ä¿¡æ¯</th><td class="text-danger">${task.error_msg}</td></tr>` : ''}
                    </tbody>
                </table>
            `;
            
            // ç»‘å®šå¤åˆ¶æŒ‰é’®äº‹ä»¶
            document.getElementById('btnCopyConfig').onclick = () => copyTaskConfig(id);
            
            const modal = new bootstrap.Modal(document.getElementById('taskDetailsModal'));
            modal.show();
        }

        function copyTaskConfig(id) {
            const task = currentTasksMap[id];
            if(!task || !task.cli_config) return;
            const c = task.cli_config;

            const setVal = (elemId, val) => {
                const el = document.getElementById(elemId);
                if(el) {
                    el.value = (val !== undefined && val !== null) ? val : "";
                    el.dispatchEvent(new Event('input'));
                    el.dispatchEvent(new Event('change'));
                }
            };

            setVal('voiceSelect', c.voice);
            setVal('volume', c.volume);
            setVal('speed', c.speed);
            setVal('pitch', c.pitch);
            setVal('concurrency', c.concurrency);
            document.getElementById('preserveStructure').checked = c.preserve_structure || false;
            
            setVal('voice_dialogue_id', c.voice_dialogue);
            setVal('volume_dialogue', c.volume_dialogue);
            setVal('speed_dialogue', c.speed_dialogue);
            setVal('pitch_dialogue', c.pitch_dialogue);

            const enableLrc = document.getElementById('enableLrc');
            if(enableLrc) {
                enableLrc.checked = (c.sub > 0);
                enableLrc.dispatchEvent(new Event('change'));
            }
            setVal('lrcChars', c.sub > 0 ? c.sub : 15);
            setVal('ignoreRegex', c.ignore_regex);

            bootstrap.Modal.getInstance(document.getElementById('taskDetailsModal')).hide();
            alert("é…ç½®å·²æˆåŠŸå¤åˆ¶åˆ°ä¸»ç•Œé¢ï¼");
        }

        async function clearCompletedTasks() {
            if(!confirm("ç¡®å®šè¦æ¸…é™¤åˆ—è¡¨ä¸­æ‰€æœ‰å·²å®Œæˆçš„ä»»åŠ¡å—ï¼Ÿ(ä¸ä¼šåˆ é™¤æ–‡ä»¶)")) return;
            try {
                await fetch('/api/clear_completed_tasks', { method: 'POST' });
                updateTasks(); // ç«‹å³åˆ·æ–°
            } catch(e) {
                alert("æ¸…é™¤å¤±è´¥: " + e);
            }
        }

        async function clearAllTasks() {
            if(!confirm("âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡è®°å½•å—ï¼Ÿ(ä¸ä¼šåˆ é™¤å·²ç”Ÿæˆçš„æ–‡ä»¶)")) return;
            try {
                await fetch('/api/clear_all_tasks', { method: 'POST' });
                updateTasks();
            } catch(e) {
                alert("æ¸…ç©ºå¤±è´¥: " + e);
            }
        }

        async function resetHistory() {
            if(!confirm("âš ï¸ ä¸¥é‡è­¦å‘Šï¼šè¿™å°†æ¸…é™¤æ‰€æœ‰ä»»åŠ¡è®°å½•ï¼ˆåŒ…æ‹¬å·²å®Œæˆçš„ä»»åŠ¡å†å²ï¼‰ã€‚\n\nè¿™æ„å‘³ç€è‡ªåŠ¨æ£€æµ‹å°†é‡æ–°æ‰«æå¹¶å¤„ç†æ‰€æœ‰æ–‡ä»¶ï¼\n\nç¡®å®šè¦ç»§ç»­å—ï¼Ÿ")) return;
            try {
                await fetch('/api/reset_history', { method: 'POST' });
                updateTasks();
            } catch(e) {
                alert("é‡ç½®å¤±è´¥: " + e);
            }
        }

        async function cancelTask(id) {
            if(!confirm("ç¡®å®šè¦å–æ¶ˆæ­¤ä»»åŠ¡å—ï¼Ÿ")) return;
            try {
                await fetch('/api/cancel_task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
            } catch(e) {
                alert("å–æ¶ˆå¤±è´¥: " + e);
            }
        }

        async function retryTask(id) {
            if(!confirm("ç¡®å®šè¦é‡è¯•æ­¤ä»»åŠ¡å—ï¼Ÿ")) return;
            try {
                await fetch('/api/retry_task', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id })
                });
            } catch(e) {
                alert("é‡è¯•å¤±è´¥: " + e);
            }
        }

        async function batchCancel() {
            if (!confirm(`ç¡®å®šè¦å–æ¶ˆé€‰ä¸­çš„ ${selectedTaskIds.size} ä¸ªä»»åŠ¡å—ï¼Ÿ`)) return;
            const ids = Array.from(selectedTaskIds);
            for (const id of ids) {
                try {
                    await fetch('/api/cancel_task', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id })
                    });
                } catch (e) {
                    console.error(e);
                }
            }
            selectedTaskIds.clear();
            updateTasks();
        }

        async function batchRetry() {
            if (!confirm(`ç¡®å®šè¦é‡è¯•é€‰ä¸­çš„ ${selectedTaskIds.size} ä¸ªä»»åŠ¡å—ï¼Ÿ`)) return;
            const ids = Array.from(selectedTaskIds);
            for (const id of ids) {
                try {
                    await fetch('/api/retry_task', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id })
                    });
                } catch (e) {
                    console.error(e);
                }
            }
            selectedTaskIds.clear();
            updateTasks();
        }

        async function retryAllFailed() {
            if(!confirm("ç¡®å®šè¦é‡è¯•æ‰€æœ‰å¤±è´¥æˆ–å·²å–æ¶ˆçš„ä»»åŠ¡å—ï¼Ÿ")) return;
            try {
                await fetch('/api/retry_all_failed', { method: 'POST' });
                // ä»»åŠ¡çŠ¶æ€ä¼šåœ¨è½®è¯¢ä¸­è‡ªåŠ¨æ›´æ–°
            } catch(e) {
                alert("è¯·æ±‚å¤±è´¥: " + e);
            }
        }

        // SSE è¿æ¥
        const eventSource = new EventSource('/api/events');
        eventSource.onmessage = (event) => {
            const btnStart = document.getElementById('btnStart');
            const btnBatch = document.getElementById('btnBatchConvert');
            const btnStop = document.getElementById('btnStop');

            const restoreButtons = () => {
                btnStart.disabled = false;
                btnStart.innerText = "å¼€å§‹åˆæˆ";
                btnBatch.disabled = false;
                btnBatch.innerText = "å¼€å§‹æ‰¹é‡è½¬æ¢";
                btnStop.disabled = true;
            };

            if (event.data === "__STATUS__:DONE" || event.data.startsWith("ğŸ›‘ ç”¨æˆ·å·²æ‰‹åŠ¨åœæ­¢")) {
                restoreButtons();
            }
            log(event.data);
        };
        eventSource.onerror = () => {
            log("ğŸ”Œ SSE è¿æ¥æ–­å¼€ï¼Œè‹¥æ— æ“ä½œå¯å¿½ç•¥ã€‚å°†åœ¨ä¸‹æ¬¡ä»»åŠ¡æ—¶é‡è¿ã€‚");
            eventSource.close();
        };

        // æ¢å¤é»˜è®¤è®¾ç½®
        document.getElementById('btnResetDefaults').addEventListener('click', () => {
            if(!confirm("ç¡®å®šè¦æ¢å¤é»˜è®¤å‚æ•°å—ï¼Ÿ")) return;
            
            const setInput = (id, val) => {
                const el = document.getElementById(id);
                if(el) {
                    el.value = val;
                    // æ‰‹åŠ¨è§¦å‘ input äº‹ä»¶ä»¥æ›´æ–°æ˜¾ç¤ºæ•°å€¼å’Œ localStorage
                    el.dispatchEvent(new Event('input'));
                }
            };

            setInput('volume', sysDefaults.volume);
            setInput('speed', sysDefaults.speed);
            setInput('pitch', sysDefaults.pitch);
            setInput('concurrency', 4);
            document.getElementById('preserveStructure').checked = false;

            setInput('volume_dialogue', sysDefaults.volume);
            setInput('speed_dialogue', sysDefaults.speed);
            setInput('pitch_dialogue', sysDefaults.pitch);
            
            const dv = document.getElementById('voice_dialogue_id');
            if(dv) {
                dv.value = "";
                dv.dispatchEvent(new Event('change'));
            }
            log("â†º å·²æ¢å¤é»˜è®¤å‚æ•°ã€‚");
        });

        // è·å–å£°éŸ³åˆ—è¡¨
        document.getElementById('btnRefreshVoices').addEventListener('click', async () => {
            const apiUrl = document.getElementById('apiUrl').value;
            if(!apiUrl) return alert("è¯·è¾“å…¥ API åœ°å€");
            
            log("æ­£åœ¨è·å–å£°éŸ³åˆ—è¡¨...");
            try {
                const res = await fetch(`/api/voices?api_url=${encodeURIComponent(apiUrl)}`);
                const data = await res.json();
                
                const select = document.getElementById('voiceSelect');
                if(data.error) {
                    log("âŒ é”™è¯¯: " + data.error);
                    populateVoices([], select);
                    return;
                }
                populateVoices(data, select);
            } catch(e) {
                log("âŒ ç½‘ç»œé”™è¯¯: " + e);
            }
        });

        // åœæ­¢åˆæˆ
        document.getElementById('btnStop').addEventListener('click', async () => {
            if(!confirm("ç¡®å®šè¦åœæ­¢å½“å‰ä»»åŠ¡å—ï¼Ÿ")) return;
            try {
                await fetch('/api/stop', { method: 'POST' });
                log("æ­£åœ¨å‘é€åœæ­¢è¯·æ±‚...");
            } catch(e) {
                log("âŒ æ— æ³•å‘é€åœæ­¢è¯·æ±‚: " + e);
            }
        });

        // æ‰¹é‡è½¬æ¢
        document.getElementById('btnBatchConvert').addEventListener('click', async () => {
            const voiceId = document.getElementById('voiceSelect').value;
            const voiceDialogueId = document.getElementById('voice_dialogue_id').value || null;
            
            const volume = parseInt(document.getElementById('volume').value);
            const speed = parseInt(document.getElementById('speed').value);
            const pitch = parseInt(document.getElementById('pitch').value);
            
            const volumeDialogue = parseInt(document.getElementById('volume_dialogue').value);
            const speedDialogue = parseInt(document.getElementById('speed_dialogue').value);
            const pitchDialogue = parseInt(document.getElementById('pitch_dialogue').value);
            
            const enableLrc = document.getElementById('enableLrc').checked;
            const lrcChars = parseInt(document.getElementById('lrcChars').value);
            const sub = enableLrc ? lrcChars : 0;
            const ignoreRegex = document.getElementById('ignoreRegex').value;
            const preserveStructure = document.getElementById('preserveStructure').checked;

            if (!voiceId) {
                return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå£°éŸ³ï¼");
            }
            if (!confirm("å³å°†å¼€å§‹æ‰¹é‡è½¬æ¢ /book ç›®å½•ä¸­çš„æ‰€æœ‰ä¹¦ç±ï¼Œç¡®å®šå—ï¼Ÿ")) {
                return;
            }

            const btn = document.getElementById('btnBatchConvert');
            const btnStart = document.getElementById('btnStart');
            const btnStop = document.getElementById('btnStop');

            btn.disabled = true;
            btnStart.disabled = true;
            btn.innerText = "æ‰¹é‡å¤„ç†ä¸­...";
            btnStop.disabled = false;

            log("â–¶ï¸ å¼€å§‹å‘é€æ‰¹é‡è½¬æ¢ä»»åŠ¡...");

            try {
                const res = await fetch('/api/batch_convert', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        voice_id: voiceId,
                        voice_dialogue_id: voiceDialogueId,
                        volume: volume,
                        speed: speed,
                        pitch: pitch,
                        volume_dialogue: volumeDialogue,
                        speed_dialogue: speedDialogue,
                        pitch_dialogue: pitchDialogue,
                        sub: sub,
                        preserve_structure: preserveStructure
                    })
                });

                const data = await res.json();
                if (data.success) {
                    log("âœ… " + data.message);
                } else {
                    log("âŒ å¯åŠ¨å¤±è´¥: " + data.message);
                    btn.disabled = false;
                    btnStart.disabled = false;
                    btn.innerText = "å¼€å§‹æ‰¹é‡è½¬æ¢";
                    btnStop.disabled = true;
                }
            } catch (e) {
                log("âŒ ç½‘ç»œæˆ–æœåŠ¡å™¨é”™è¯¯: " + e);
                btn.disabled = false;
                btnStart.disabled = false;
                btn.innerText = "å¼€å§‹æ‰¹é‡è½¬æ¢";
                btnStop.disabled = true;
            }
        });

        let isAutoRun = false;
        async function checkAutoRunStatus() {
            try {
                const res = await fetch('/api/autorun/status');
                const data = await res.json();
                isAutoRun = data.enabled;
                updateAutoRunButton();
            } catch(e) { console.error(e); }
        }

        function updateAutoRunButton() {
            const btn = document.getElementById('btnAutoRun');
            if (isAutoRun) {
                btn.innerText = "ğŸ¤– åœæ­¢è‡ªåŠ¨æ£€æµ‹";
                btn.classList.remove('btn-outline-success');
                btn.classList.add('btn-success');
            } else {
                btn.innerText = "ğŸ¤– å¼€å¯è‡ªåŠ¨æ£€æµ‹";
                btn.classList.remove('btn-success');
                btn.classList.add('btn-outline-success');
            }
        }

        document.getElementById('btnAutoRun').addEventListener('click', async () => {
            const newState = !isAutoRun;
            let body = { enabled: newState };
            
            if (newState) {
                const voiceId = document.getElementById('voiceSelect').value;
                if (!voiceId) return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå£°éŸ³ï¼");
                
                body.config = {
                    voice_id: voiceId,
                    voice_dialogue_id: document.getElementById('voice_dialogue_id').value || null,
                    volume: parseInt(document.getElementById('volume').value),
                    speed: parseInt(document.getElementById('speed').value),
                    pitch: parseInt(document.getElementById('pitch').value),
                    volume_dialogue: parseInt(document.getElementById('volume_dialogue').value),
                    speed_dialogue: parseInt(document.getElementById('speed_dialogue').value),
                    pitch_dialogue: parseInt(document.getElementById('pitch_dialogue').value),
                    sub: document.getElementById('enableLrc').checked ? parseInt(document.getElementById('lrcChars').value) : 0,
                    ignore_regex: document.getElementById('ignoreRegex').value,
                    preserve_structure: document.getElementById('preserveStructure').checked
                };
            }

            try {
                const res = await fetch('/api/autorun', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                const data = await res.json();
                if (data.success) {
                    isAutoRun = newState;
                    updateAutoRunButton();
                    log("âœ… " + data.message);
                } else {
                    alert("æ“ä½œå¤±è´¥: " + data.message);
                }
            } catch(e) { alert("ç½‘ç»œé”™è¯¯: " + e); }
        });

        // è¯•å¬åŠŸèƒ½
        document.getElementById('btnPreview').addEventListener('click', async () => {
            const text = document.getElementById('textContent').value;
            if(!text) return alert("è¯·è¾“å…¥è¦è¯•å¬çš„æ–‡æœ¬");
            
            const apiUrl = document.getElementById('apiUrl').value;
            const voiceId = document.getElementById('voiceSelect').value;
            if(!voiceId) return alert("è¯·å…ˆé€‰æ‹©å£°éŸ³");
            
            const volume = parseInt(document.getElementById('volume').value);
            const speed = parseInt(document.getElementById('speed').value);
            const pitch = parseInt(document.getElementById('pitch').value);
            const ignoreRegex = document.getElementById('ignoreRegex').value;

            const voiceDialogueId = document.getElementById('voice_dialogue_id').value || null;
            const volumeDialogue = parseInt(document.getElementById('volume_dialogue').value);
            const speedDialogue = parseInt(document.getElementById('speed_dialogue').value);
            const pitchDialogue = parseInt(document.getElementById('pitch_dialogue').value);
            
            const btn = document.getElementById('btnPreview');
            const btnDownload = document.getElementById('btnDownloadPreview');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "ç”Ÿæˆä¸­...";
            btnDownload.style.display = 'none';
            
            const audioPlayer = document.getElementById('audioPreview');
            audioPlayer.style.display = 'none';
            audioPlayer.pause();
            
            try {
                const res = await fetch('/api/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        api_url: apiUrl,
                        voice_id: voiceId,
                        text_content: text,
                        volume, speed, pitch,
                        voice_dialogue_id: voiceDialogueId,
                        volume_dialogue: volumeDialogue,
                        speed_dialogue: speedDialogue,
                        pitch_dialogue: pitchDialogue,
                        ignore_regex: ignoreRegex
                    })
                });
                
                if(res.ok) {
                    const blob = await res.blob();
                    const url = URL.createObjectURL(blob);
                    audioPlayer.src = url;
                    audioPlayer.style.display = 'block';
                    audioPlayer.play();

                    btnDownload.style.display = 'inline-block';
                    btnDownload.onclick = () => {
                        const a = document.createElement('a');
                        a.href = url;
                        const filename = document.getElementById('outputName').value || 'preview_audio';
                        a.download = filename.endsWith('.wav') ? filename : filename + '.wav';
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                    };
                } else {
                    const err = await res.json();
                    alert("è¯•å¬å¤±è´¥: " + (err.message || "æœªçŸ¥é”™è¯¯"));
                }
            } catch(e) {
                alert("ç½‘ç»œé”™è¯¯: " + e);
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
            }
        });

        // å¼€å§‹åˆæˆ
        document.getElementById('btnStart').addEventListener('click', async () => {
            const apiUrl = document.getElementById('apiUrl').value;
            const voiceId = document.getElementById('voiceSelect').value;
            const volume = parseInt(document.getElementById('volume').value);
            const speed = parseInt(document.getElementById('speed').value);
            const pitch = parseInt(document.getElementById('pitch').value);
            const concurrency = parseInt(document.getElementById('concurrency').value);
            
            const voiceDialogueId = document.getElementById('voice_dialogue_id').value || null;
            const volumeDialogue = parseInt(document.getElementById('volume_dialogue').value);
            const speedDialogue = parseInt(document.getElementById('speed_dialogue').value);
            const pitchDialogue = parseInt(document.getElementById('pitch_dialogue').value);
            
            const enableLrc = document.getElementById('enableLrc').checked;
            const lrcChars = parseInt(document.getElementById('lrcChars').value);
            const sub = enableLrc ? lrcChars : 0;
            const ignoreRegex = document.getElementById('ignoreRegex').value;
            
            const isTextMode = document.getElementById('text-tab').classList.contains('active');
            const isFileMode = document.getElementById('file-tab').classList.contains('active');
            const isUploadMode = document.getElementById('upload-tab').classList.contains('active');
            
            let textContent = null;
            let filePath = null;
            let outputName = null;
            let uploadFile = null;

            if(isTextMode) {
                textContent = document.getElementById('textContent').value;
                outputName = document.getElementById('outputName').value || null;
                if(!textContent) return alert("è¯·è¾“å…¥æ–‡æœ¬");
            } else if (isFileMode) {
                filePath = document.getElementById('filePath').value;
                if(!filePath) return alert("è¯·è¾“å…¥æ–‡ä»¶è·¯å¾„");
            } else if (isUploadMode) {
                const fileInput = document.getElementById('uploadFile');
                if (fileInput.files.length === 0) return alert("è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶");
                uploadFile = fileInput.files[0];
            }

            if(!voiceId) return alert("è¯·å…ˆé€‰æ‹©å£°éŸ³");

            const btn = document.getElementById('btnStart');
            const btnBatch = document.getElementById('btnBatchConvert');
            const btnStop = document.getElementById('btnStop');
            
            btn.disabled = true;
            btnBatch.disabled = true;
            btn.innerText = "å¤„ç†ä¸­...";
            btnStop.disabled = false;
            
            log("â–¶ï¸ å¼€å§‹å‘é€åˆæˆä»»åŠ¡...");

            try {
                let res;
                if (isUploadMode) {
                    const formData = new FormData();
                    formData.append('api_url', apiUrl);
                    formData.append('voice_id', voiceId);
                    formData.append('volume', volume);
                    formData.append('speed', speed);
                    formData.append('pitch', pitch);
                    formData.append('concurrency', concurrency);
                    if(voiceDialogueId) formData.append('voice_dialogue_id', voiceDialogueId);
                    formData.append('volume_dialogue', volumeDialogue);
                    formData.append('speed_dialogue', speedDialogue);
                    formData.append('pitch_dialogue', pitchDialogue);
                    formData.append('file', uploadFile);
                    formData.append('sub', sub);
                    formData.append('ignore_regex', ignoreRegex);
                    
                    res = await fetch('/api/synthesize_upload', {
                        method: 'POST',
                        body: formData
                    });
                } else {
                    res = await fetch('/api/synthesize', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            api_url: apiUrl,
                            voice_id: voiceId,
                            voice_dialogue_id: voiceDialogueId,
                            volume_dialogue: volumeDialogue,
                            speed_dialogue: speedDialogue,
                            pitch_dialogue: pitchDialogue,
                            text_content: textContent,
                            file_path: filePath,
                            volume, speed, pitch,
                            output_name: outputName,
                            sub: sub,
                            concurrency: concurrency,
                            ignore_regex: ignoreRegex
                        })
                    });
                }
                
                const data = await res.json();
                if(data.success) {
                    log("âœ… " + data.message);
                } else {
                    log("âŒ å¯åŠ¨å¤±è´¥: " + data.message);
                    btn.disabled = false;
                    btnBatch.disabled = false;
                    btn.innerText = "å¼€å§‹åˆæˆ";
                    btnStop.disabled = true;
                }
            } catch(e) {
                log("âŒ ç½‘ç»œæˆ–æœåŠ¡å™¨é”™è¯¯: " + e);
                btn.disabled = false;
                btnBatch.disabled = false;
                btn.innerText = "å¼€å§‹åˆæˆ";
                btnStop.disabled = true;
            } 
        });

        // --- æ–‡ä»¶ç®¡ç†å™¨é€»è¾‘ ---
        let fmCurrentRoot = 'book';
        let fmCurrentPath = '';

        document.querySelectorAll('input[name="fmRoot"]').forEach(el => {
            el.addEventListener('change', (e) => {
                fmCurrentRoot = e.target.value;
                fmCurrentPath = ''; // åˆ‡æ¢æ ¹ç›®å½•æ—¶é‡ç½®è·¯å¾„
                // åªæœ‰ book ç›®å½•å…è®¸ä¸Šä¼ 
                document.getElementById('btnFmUpload').style.display = fmCurrentRoot === 'book' ? 'inline-block' : 'none';
                fmLoadFiles();
            });
        });

        document.getElementById('btnFmRefresh').addEventListener('click', fmLoadFiles);

        async function fmLoadFiles() {
            const tbody = document.getElementById('fmFileList');
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">åŠ è½½ä¸­...</td></tr>';
            
            updateBreadcrumb();

            try {
                const res = await fetch(`/api/files/list?root=${fmCurrentRoot}&path=${encodeURIComponent(fmCurrentPath)}`);
                if (!res.ok) throw new Error("åŠ è½½å¤±è´¥");
                const files = await res.json();
                
                tbody.innerHTML = '';
                
                if (fmCurrentPath !== '') {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td colspan="4">
                            <a href="#" onclick="event.preventDefault(); fmNavigateUp()" class="text-decoration-none">
                                <i class="bi bi-arrow-return-left"></i> è¿”å›ä¸Šä¸€çº§
                            </a>
                        </td>`;
                    tbody.appendChild(tr);
                }

                if (files.length === 0) {
                    tbody.innerHTML += '<tr><td colspan="4" class="text-center text-muted">ç©ºç›®å½•</td></tr>';
                    return;
                }

                files.forEach(f => {
                    const tr = document.createElement('tr');
                    const icon = f.is_dir ? '<i class="bi bi-folder-fill text-warning"></i>' : '<i class="bi bi-file-earmark-text text-secondary"></i>';
                    const size = f.is_dir ? '-' : formatSize(f.size);
                    const date = new Date(f.modified * 1000).toLocaleString();
                    const nameLink = f.is_dir 
                        ? `<a href="#" onclick="event.preventDefault(); fmNavigate('${f.name}')" class="fw-bold text-decoration-none text-dark">${f.name}</a>`
                        : f.name;
                    
                    const downloadBtn = !f.is_dir ? `<a href="/api/files/download?root=${fmCurrentRoot}&path=${encodeURIComponent((fmCurrentPath ? fmCurrentPath + '/' : '') + f.name)}" class="btn btn-sm btn-link p-0 me-2" title="ä¸‹è½½"><i class="bi bi-download"></i></a>` : '';
                    const deleteBtn = `<button class="btn btn-sm btn-link p-0 text-danger" onclick="fmDelete('${f.name}')" title="åˆ é™¤"><i class="bi bi-trash"></i></button>`;

                    tr.innerHTML = `
                        <td>${icon} ${nameLink}</td>
                        <td>${size}</td>
                        <td>${date}</td>
                        <td class="text-end">${downloadBtn}${deleteBtn}</td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (e) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">åŠ è½½å¤±è´¥: ${e.message}</td></tr>`;
            }
        }

        function fmNavigate(dirName) {
            fmCurrentPath = fmCurrentPath ? `${fmCurrentPath}/${dirName}` : dirName;
            fmLoadFiles();
        }

        function fmNavigateUp() {
            if (!fmCurrentPath) return;
            const parts = fmCurrentPath.split('/');
            parts.pop();
            fmCurrentPath = parts.join('/');
            fmLoadFiles();
        }

        function updateBreadcrumb() {
            const bc = document.getElementById('fmBreadcrumb');
            bc.innerHTML = `<li class="breadcrumb-item"><a href="#" onclick="event.preventDefault(); fmCurrentPath=''; fmLoadFiles();">/</a></li>`;
            if (fmCurrentPath) {
                const parts = fmCurrentPath.split('/');
                let accum = '';
                parts.forEach((p, i) => {
                    accum = accum ? `${accum}/${p}` : p;
                    if (i === parts.length - 1) {
                        bc.innerHTML += `<li class="breadcrumb-item active">${p}</li>`;
                    } else {
                        // é—­åŒ…é™·é˜±ï¼Œè¿™é‡Œç®€å•å¤„ç†ï¼Œç›´æ¥ç”¨ accum å­—ç¬¦ä¸²
                        const pathRef = accum; 
                        bc.innerHTML += `<li class="breadcrumb-item"><a href="#" onclick="event.preventDefault(); fmCurrentPath='${pathRef}'; fmLoadFiles();">${p}</a></li>`;
                    }
                });
            }
            document.getElementById('uploadTargetDir').innerText = '/' + fmCurrentPath;
        }

        async function fmDelete(name) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ "${name}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
            const fullPath = fmCurrentPath ? `${fmCurrentPath}/${name}` : name;
            try {
                const res = await fetch('/api/files/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ root: fmCurrentRoot, path: fullPath })
                });
                const data = await res.json();
                if (data.success) {
                    fmLoadFiles();
                } else {
                    alert("åˆ é™¤å¤±è´¥: " + data.message);
                }
            } catch (e) { alert("ç½‘ç»œé”™è¯¯: " + e); }
        }

        document.getElementById('btnConfirmUpload').addEventListener('click', async () => {
            const input = document.getElementById('fmUploadInput');
            if (input.files.length === 0) return alert("è¯·é€‰æ‹©æ–‡ä»¶");
            
            const formData = new FormData();
            formData.append('root', fmCurrentRoot);
            formData.append('path', fmCurrentPath);
            for (let i = 0; i < input.files.length; i++) {
                formData.append('file', input.files[i]);
            }

            const btn = document.getElementById('btnConfirmUpload');
            btn.disabled = true;
            btn.innerText = "ä¸Šä¼ ä¸­...";

            try {
                const res = await fetch('/api/files/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
                    input.value = '';
                    fmLoadFiles();
                } else {
                    alert("ä¸Šä¼ å¤±è´¥: " + data.message);
                }
            } catch (e) { alert("ç½‘ç»œé”™è¯¯: " + e); }
            finally {
                btn.disabled = false;
                btn.innerText = "å¼€å§‹ä¸Šä¼ ";
            }
        });

        function formatSize(bytes) {
            if (bytes === 0 || !bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>